rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin (master admin)
    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if user is a promoter
    function isPromoter() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'promoter';
    }

    // Helper function to get user's promoterId
    function getUserPromoterId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.promoterId;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || request.auth.uid == userId;
    }

    // Promoters collection
    match /promoters/{promoterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Events collection
    match /events/{eventId} {
      allow read: if true; // Public read for event pages
      allow write: if isAdmin() ||
        (isPromoter() && resource.data.promoterId == getUserPromoterId());
    }

    // Orders collection
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow create: if true; // Allow public order creation
      allow update, delete: if isAdmin();
    }

    // Customers collection
    match /customers/{customerId} {
      allow read, write: if isAuthenticated();
    }

    // Payment gateways collection
    match /payment_gateways/{gatewayId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // =========================================
    // CMS Collections (Advanced White-Label)
    // =========================================

    // Tenant Themes collection
    match /tenantThemes/{themeId} {
      // Allow read if authenticated (for admins and promoters)
      allow read: if isAuthenticated();

      // Allow create if admin OR if promoter creating for their own tenant
      allow create: if isAdmin() ||
        (isPromoter() && request.resource.data.tenantId == getUserPromoterId());

      // Allow update/delete if admin OR if promoter owns this theme
      allow update, delete: if isAdmin() ||
        (isPromoter() && resource.data.tenantId == getUserPromoterId());
    }

    // Tenant Pages collection
    match /tenantPages/{pageId} {
      // Allow read if authenticated
      allow read: if isAuthenticated();

      // Allow create if admin OR if promoter creating for their own tenant
      allow create: if isAdmin() ||
        (isPromoter() && request.resource.data.tenantId == getUserPromoterId());

      // Allow update/delete if admin OR if promoter owns this page
      allow update, delete: if isAdmin() ||
        (isPromoter() && resource.data.tenantId == getUserPromoterId());
    }

    // Page Versions collection (for rollback support)
    match /pageVersions/{versionId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isPromoter();
      allow update, delete: if isAdmin();
    }

    // CMS Translations collection
    match /cmsTranslations/{translationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isPromoter();
    }

    // =========================================
    // Other existing collections
    // =========================================

    // Seat maps collection
    match /seatMaps/{seatMapId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // Venues collection
    match /venues/{venueId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // Analytics collection
    match /analytics/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
  }
}
